# Enable rewrite engine
RewriteEngine On
RewriteBase /

# Pass Authorization header to PHP scripts
RewriteCond %{HTTP:Authorization} .
RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

# API Routes - handle these first
RewriteRule ^api/auth/login/?$ php-api/auth.php [L]
RewriteRule ^api/auth/validate/?$ php-api/auth.php [L]
RewriteRule ^api/assemblies/?$ php-api/assemblies.php [L,QSA]
RewriteRule ^api/categories/?$ php-api/categories.php [L]
RewriteRule ^api/annotations/?$ php-api/annotations.php [L]
RewriteRule ^api/upload/?$ php-api/upload.php [L]
RewriteRule ^api/tenant/branding/?$ php-api/tenant/branding.php [L,QSA]
RewriteRule ^api/admin/assemblies/([^/]+)/steps/([^/]+)/animation/?$ php-api/admin/animation.php?assemblyId=$1&stepId=$2 [L,QSA]

# Map asset directories directly to the web root (static export)
RewriteRule ^(images|models|audio|cabinets)/(.+)$ $1/$2 [L]

# Serve static files directly (images, JS, CSS, etc.)
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# Dynamic assembly routes - map to template folders
# /admin/assemblies/BC-003/steps/authoring?step=4 -> /admin/assemblies/[id]/steps/authoring/index.html
RewriteRule ^admin/assemblies/[^/]+/steps/authoring/?$ admin/assemblies/[id]/steps/authoring/index.html [L,QSA]

# /admin/assemblies/BC-003/steps/4/authoring -> /admin/assemblies/[id]/steps/[stepId]/authoring/index.html
RewriteRule ^admin/assemblies/[^/]+/steps/[^/]+/authoring/?$ admin/assemblies/[id]/steps/[stepId]/authoring/index.html [L]

# /admin/assemblies/BC-003/steps/4/edit -> /admin/assemblies/[id]/steps/[stepId]/edit/index.html
RewriteRule ^admin/assemblies/[^/]+/steps/[^/]+/edit/?$ admin/assemblies/[id]/steps/[stepId]/edit/index.html [L]

# /admin/assemblies/BC-003/steps/new -> /admin/assemblies/[id]/steps/new/index.html
RewriteRule ^admin/assemblies/[^/]+/steps/new/?$ admin/assemblies/[id]/steps/new/index.html [L]

# /admin/assemblies/BC-003/steps -> /admin/assemblies/[id]/steps/index.html
RewriteRule ^admin/assemblies/[^/]+/steps/?$ admin/assemblies/[id]/steps/index.html [L]

# /admin/assemblies/BC-003/edit -> /admin/assemblies/[id]/edit/index.html
RewriteRule ^admin/assemblies/[^/]+/edit/?$ admin/assemblies/[id]/edit/index.html [L]

# /admin/assemblies/new -> /admin/assemblies/new/index.html
RewriteRule ^admin/assemblies/new/?$ admin/assemblies/new/index.html [L]

# Public dynamic routes - map to template folders
# /categories/base -> /categories/[category]/index.html
RewriteRule ^categories/[^/]+/?$ categories/[category]/index.html [L]

# /assembly/BC-003 -> /assembly/[id]/index.html
RewriteRule ^assembly/[^/]+/?$ assembly/[id]/index.html [L]

# /assembly/BC-003/step/1 -> /assembly/[id]/step/[stepId]/index.html
RewriteRule ^assembly/[^/]+/step/[^/]+/?$ assembly/[id]/step/[stepId]/index.html [L]

# Check if directory with index.html exists
RewriteCond %{REQUEST_FILENAME}/index.html -f
RewriteRule ^(.*)$ $1/index.html [L]

# Try adding .html extension
RewriteCond %{REQUEST_FILENAME}.html -f
RewriteRule ^(.*)$ $1.html [L]

# Fallback to 404
RewriteRule ^(.*)$ 404.html [L]

# Enable CORS
Header always set Access-Control-Allow-Origin "*"
Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
Header always set Access-Control-Allow-Headers "Content-Type, Authorization"

# Prevent caching of API responses
<FilesMatch "\.php$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
</FilesMatch>

# Enable gzip compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# Browser caching for static assets only
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    # Don't cache JSON API responses - removed: ExpiresByType application/json
</IfModule>
